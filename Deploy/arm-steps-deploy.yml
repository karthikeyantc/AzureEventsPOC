parameters:
  taskAzureResourceManagerConnection: ''
  taskResourceGroupName: ''
  taskEnvironmentFilePath: ''
  taskLocation: ''
  taskSubscriptionId: ''
  taskOverideParameters: ''

steps:

- template: arm-resources-steps-deploy.yml
  parameters:
    name: AzureResourceManagerTemplateDeployment@3
    displayName: 'Deploy Resources to Azure'
    azureResourceManagerConnection: ${{ parameters.taskAzureResourceManagerConnection }}
    resourceGroupName: ${{ parameters.taskResourceGroupName }}
    file: '$(Pipeline.Workspace)/drop/Resources/azuredeploy.json'
    csmParametersFile: ${{ parameters.taskEnvironmentFilePath }}
    Location: ${{ parameters.taskLocation }}
    subscriptionId: ${{ parameters.taskSubscriptionId }}
    overrideParameters: ${{ parameters.taskOverideParameters }}

# - task: ARM Outputs@5
#   displayName: 'ARM Outputs'
#   inputs:
#     ConnectedServiceNameARM: ${{ parameters.taskAzureResourceManagerConnection }}
#     ResourceGroupName: ${{ parameters.taskResourceGroupName }}'
#     Prefix: 'ARMOutput_'
#     whenLastDeploymentFailed: 'fail'
- task: DownloadPipelineArtifact@2
  inputs:
    artifact: 'drop'
    path: '$(Pipeline.Workspace)/drop'
- task: AzureRmWebAppDeployment@4
  displayName: 'Deploy Azure Function App'
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: ${{ parameters.taskSubscriptionId }}
    appType: 'functionApp'
    WebAppName: ${{ replace(parameters.taskResourceGroupName, 'rg', 'func')}}
    package: '**/*.zip'
    ConnectedServiceName: ${{ parameters.taskAzureResourceManagerConnection }}
# - task: AzureFunctionApp@1
#   displayName: 'Azure Function App Deploy'
#   inputs:
#     ConnectedServiceName: ${{ parameters.taskAzureResourceManagerConnection }}
#     azureSubscription: ${{ parameters.taskSubscriptionId }}
#     appType: functionApp
#     appName: ${{ replace(parameters.taskResourceGroupName, 'rg', 'func')}}
#     package: '$(Pipeline.Workspace)/drop/AzureEvent.Function.zip'
#     deploymentMethod: 'auto'
#     RuntimeStack: 'dotnet'
#     RuntimeVersion: '6.0'
#     StartupCommand: 'AzureEvent.Function.dll'
#     ScriptType: 'CSharp'
#     ConfigurationSettings: '-FUNCTIONS_WORKER_RUNTIME dotnet'

- template: arm-resources-steps-deploy.yml
  parameters:
    name: AzureResourceManagerTemplateDeployment@3
    displayName: 'Deploy Resources to Azure'
    azureResourceManagerConnection: ${{ parameters.taskAzureResourceManagerConnection }}
    resourceGroupName: ${{ parameters.taskResourceGroupName }}
    file: '$(Pipeline.Workspace)/drop/Resources/azuredeployEventGrid.json'
    csmParametersFile: ${{ parameters.taskEnvironmentFilePath }}
    Location: ${{ parameters.taskLocation }}
    subscriptionId: ${{ parameters.taskSubscriptionId }}
    overrideParameters: ${{ parameters.taskOverideParameters }}