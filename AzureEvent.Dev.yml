trigger: none

pool:
  vmImage: 'windows-latest'

parameters:
- name: DisplayOutputs
  displayName: Display Outputs?
  type: boolean
  default: true

variables:
  solution: 'AzureEvent'
  buildConfiguration: 'Release'
  buildPlatform: 'Any CPU'
  
stages:
- stage: Build
  displayName: Build
  jobs:
  - job: Build
    displayName: 'Build'
    steps:
    - task: NugetToolInstaller@1
    - task: NugetCommand@2
      inputs:
        command: 'restore'
        restoreSolution: '**/*.sln'
    - task: VSBuild@1
      displayName: 'Build solution'
      inputs:
        solution: '**/*.sln'
        msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:DesktopBuildPackageLocation="$(build.artifactStagingDirectory)\AzureEvent.Function.zip" /p:DeployIisAppPath="Default Web Site"'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'
    - task: CopyFiles@2
      displayName: 'Copy Files to: $(build.artifactStagingDirectory)'
      inputs:
        SourceFolder: '$(System.DefaultWorkingDirectory)'
        Contents: '**\bin\$(buildConfiguration)\**'
        TargetFolder: '$(build.artifactStagingDirectory)'
        CleanTargetFolder: true
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'
      inputs:
        PathtoPublish: '$(build.artifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
        condition: succeededOrFailed()
- stage: Deploy
  displayName: Deploy
  dependsOn: Build
  condition: 'succeeded(''Build'')'
  jobs:
  - deployment: Deploy
    displayName: 'Deploy'
    environment: 'AzureEvent-Dev'
    strategy:
      runOnce:
        deploy:
          steps:
          - template: Deploy/arm-steps-deploy.yml
            parameters:
              taskAzureResourceManagerConnection: 'Azure For Students'
              taskResourceGroupName: 'rg-azureevent-dev'
              taskEnvironmentFilePath: '$(build.artifactStagingDirectory)/AzureEvent/Resources/azuredeploy.parameters.json'
              taskLocation: 'East US'
              taskSubscriptionId: '7f6a8cca-0003-48bf-bc34-52e6710ed352'
              taskOverideParameters: '-webAppName $(solution)-dev -storageAccountName $(solution)dev -location "East US"'
